# This is a basic workflow to help you get started with Actions

name: CI

# Run every hour
on:
  push:
    branches:
      - feature/*
  schedule:
    - cron: 0 * * * *

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: 1.16
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          # either 'goreleaser' (default) or 'goreleaser-pro'
          distribution: goreleaser
          version: latest
          args: --snapshot --skip-publish --rm-dist
      - uses: FedericoCarboni/setup-ffmpeg@v1
        with:
          # Not strictly necessary, but it may prevent rate limit
          # errors especially on GitHub-hosted macos machines.
          token: ${{ secrets.GITHUB_TOKEN }}
        id: setup-ffmpeg

      - name: Install tsvUtils
        run: |
          curl -L -O https://github.com/eBay/tsv-utils/releases/download/v2.2.1/tsv-utils-v2.2.1_osx-x86_64_ldc2.tar.gz
          tar -zxvf tsv-utils-v2.2.1_osx-x86_64_ldc2.tar.gz
          ls
      - name: Cache Unsplash
        id: cache-unsplash
        uses: actions/cache@v2
        with:
          path: dataset.zip
          key: ${{ runner.os }}-dataset

      - name: Download Unsplash dataset
        if: steps.cache-unsplash.outputs.cache-hit != 'true'
        run: |
          sudo apt-get install fastjar
          curl -L -O https://unsplash.com/data/lite/latest
          mv latest dataset.zip
          jar xvf dataset

      - name: Build
        id: build
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          sudo mv dist/movie-maker_linux_amd64/movie-maker /usr/bin/movie-maker
          sudo chmod +x /usr/bin/movie-maker
          mkdir -p frames
          /usr/bin/movie-maker
          f=$(( ( RANDOM % 24 )  + 1 ))
          curl -H "Authorization: ${PEXELS_API_KEY}" "https://api.pexels.com/v1/curated?per_page=1" > res.json
          photographer=$(cat res.json | jq -rc '.photos[0].photographer')
          photographerUrl=$(cat res.json | jq -rc '.photos[0].photographer_url')
          imageUri=$(cat res.json | jq -rc '.photos[0].src.original')
          smallImageUri=$(cat res.json | jq -rc '.photos[0].src.small')
          mediumImageUri=$(cat res.json | jq -rc '.photos[0].src.medium')
          echo "Substitute frame #${f} with $imageUri"
          curl $imageUri -o "frames/seq-${f}.jpeg"
          ffmpeg -framerate 3 -i frames/seq-%d.jpeg -r 8 -c:v libx264 -pix_fmt yuvj420p dist/out.mp4
          touch release.md
          today=$(date +'%m-%d-%Y')
          echo "### $today ðŸ‘¨â€ðŸŽ¤ " >> release.md
          echo "![alt Image by $photographer]($mediumImageUri \"Image by $photographer\")" >> release.md
          echo "> Author: [$photographer]($photographerUrl)" >> release.md
          echo "::set-output name=version::latest"
      - name: Upload assets
        uses: actions/upload-artifact@v2
        with:
          name: frame
          path: dist/*.mp4
      - uses: ncipollo/release-action@v1
        id: xrelease
        with:
          allowUpdates: true
          bodyFile: release.md
          tag: ${{ steps.build.outputs.version }}
          artifacts: "dist/*.mp4"
          removeArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
